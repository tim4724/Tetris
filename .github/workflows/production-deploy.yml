name: Production Deploy

on:
  push:
    tags:
      - '[0-9]*'

jobs:
  build:
    uses: ./.github/workflows/docker-publish.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  deploy:
    runs-on: [self-hosted, k8s]
    needs: build
    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Write kubeconfig
        run: |
          echo "${KUBECONFIG_B64}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> "$GITHUB_ENV"
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

      - name: Deploy to production
        env:
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${REPO}:${TAG}"

          echo "Deploying ${TAG} to production"
          kubectl set image deployment/tetris \
            tetris="${IMAGE}" -n default
          kubectl rollout status deployment/tetris -n default --timeout=120s

          {
            echo "### Production Deploy ${TAG}"
            echo "- Image: \`${IMAGE}\`"
          } >> "$GITHUB_STEP_SUMMARY"
